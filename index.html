<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LINE → JotForm</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial; padding: 24px; }
    .card { max-width: 560px; margin: 12vh auto; padding: 20px; border: 1px solid #eee; border-radius: 12px; }
    .muted { color:#666; font-size:14px; word-break: break-all; }
    button { padding:10px 16px; border-radius:10px; border:1px solid #ddd; cursor:pointer; }
  </style>
</head>
<body>
  <div class="card">
    <h3>正在確認您的 LINE 身分…</h3>
    <p class="muted">若未自動跳轉，請點下方按鈕再試一次。</p>
    <button id="retry">重新嘗試</button>
    <pre id="log" class="muted"></pre>
  </div>

  <script>
    // ===== 改這裡 =====
    const LIFF_ID = "2007910544-2jm0ljGP"; // 例：165xxxxxx-xxxxxx
    const YOUR_JOTFORM_URL = "https://form.jotform.com/251894365218465";
    const FIELD_LINE_NAME = "line_name"; // JotForm 欄位 unique name
    const FIELD_LINE_ID   = "line_id";   // JotForm 欄位 unique name
    // ==================

    const logEl = document.getElementById("log");
    const retryBtn = document.getElementById("retry");
    const log = (m, d) => logEl.textContent += `\n${m}${d ? ": " + JSON.stringify(d,null,2) : ""}`;

    async function go() {
      try {
        await liff.init({ liffId: LIFF_ID });

        // 若不在 LINE 內建瀏覽器，要求登入（支援外部瀏覽器調試）
        if (!liff.isLoggedIn()) {
          liff.login({}); // 登入後會回到同一頁
          return;
        }

        // 取得使用者資料
        const profile = await liff.getProfile();
        const displayName = profile.displayName || "";
        const userId = profile.userId || "";

        // 組 JotForm 參數
        const params = new URLSearchParams();
        params.set(FIELD_LINE_NAME, displayName);
        params.set(FIELD_LINE_ID,   userId);

        const target = `${YOUR_JOTFORM_URL}?${params.toString()}`;
        log("Redirecting to", target);

        // 轉跳
        window.location.replace(target);
      } catch (e) {
        console.error(e);
        log("ERROR", { message: e.message || String(e) });
      }
    }

    retryBtn.addEventListener("click", go);
    go();
  </script>
</body>
</html>
